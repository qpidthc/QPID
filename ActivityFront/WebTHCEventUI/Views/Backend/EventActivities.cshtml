
@using System.Data;
@using System.Collections.Generic;
@using System.Collections.Specialized;

@{
    ViewBag.Title = "THC 活動控制台";
    Layout = "~/Views/Shared/_THCBackend.cshtml";
}

<style>
    label{
        color:#0026ff !important;
    }
</style>


<div class="container-fluid">

    <div style="width:100%;padding-top:10px;margin-bottom:10px;">
        <div>
            <strong class="event-title"> 活動管理   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img id="img_bar" src="~/bc/img/progress_bar.gif" style="height:18px;display:none;"></strong>
            <hr class="style2" />
        </div>

        <div class="form-inline ">
            <label class="control-label" for="txt_sh_eventno">活動清單</label>
            <div class="input-group">
                <input type="text" class="form-control " id="txt_sh_eventno" name="txt_sh_eventno" aria-label="...">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-default dropdown-toggle btn-info" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">清單 <span class="caret"></span></button>
                    <ul class="dropdown-menu dropdown-menu-right">
                        @foreach (var row in @ViewBag.Data.Rows)
                        {
                            <li><a href="#">@row["AE002"] <span>@row["AE003"]</span> </a></li>
                        }
                    </ul>
                </div><!-- /btn-group -->
            </div><!-- /input-group -->
        </div>



    </div>
    <br />

    <div id="div_content" class="panel panel-info" style="display:block;">
        <div class="panel-heading">
            <div class="panel-title pull-left">&nbsp;</div>
            
            <div class="clearfix"></div>
        </div>
        <div class="panel-body">

            <form id="form1" class="form" action="" role="form">
                <!--data-toggle="validator" -->

                <div class="row">
                    <div class="form-group col-md-4 form-inline">
                        <label for="txt_account">活動代碼</label>
                        <input type="text" class="form-control" id="txt_event_no" name="txt_event_no" maxlength="20" data-error="lan.Error_Event_No" value="" readonly>
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="form-group col-md-4 form-inline">
                        <label for="txt_event_name">活動名稱</label>
                        <input type="text" class="form-control" id="txt_event_name" name="txt_event_name" maxlength="20" data-error="lan.Error_Event_Name" readonly>
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="form-group col-md-4 form-inline">
                        <label for="txt_vender">活動廠商</label>
                        <input type="text" class="form-control" id="txt_vender" name="txt_vender" maxlength="20" data-error="lan.Error_Event_Name" readonly>
                        <div class="help-block with-errors"></div>                     
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-md-4 form-inline">
                        <label for="txt_start_date">開始日期</label>
                        <input type="text" class="form-control" id="txt_start_date" name="txt_start_date" maxlength="20" data-error="lan.Error_Event_No" readonly>
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="form-group col-md-4 form-inline">
                        <label for="txt_end_date">結束日期</label>
                        <input type="text" class="form-control" id="txt_end_date" name="txt_end_date" maxlength="20" data-error="lan.Error_Event_Name" readonly>
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="form-group col-md-4 form-inline">
                        <label for="txt_number">發碼數量</label>
                        <input type="text" class="form-control" id="txt_number" name="txt_number" maxlength="20" data-error="lan.Error_Event_Name" readonly>
                        <div class="help-block with-errors"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-md-4 form-inline">
                        <label for="txt_product">商品系列</label>
                        <input type="text" class="form-control" id="txt_product" name="txt_product" maxlength="20" data-error="lan.Error_Event_No" readonly>
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="form-group col-md-4 form-inline">
                        <label for="txt_activity_url">活動網址</label>
                        <input type="text" class="form-control" id="txt_activity_url" name="txt_activity_url" maxlength="20" data-error="lan.Error_Event_Name" readonly>
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="form-group col-md-4 form-inline">
                        <label for="txt_type">活動類型</label>
                        <input type="text" class="form-control" id="txt_type" name="txt_type" maxlength="20" data-error="lan.Error_Event_Name" readonly>
                        <div class="help-block with-errors"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-md-4 form-inline">
                        <label for="txt_memo">活動備註</label>
                        <input type="text" class="form-control" id="txt_memo" name="txt_memo" maxlength="20" data-error="lan.Error_Event_No" readonly>
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="form-group col-md-4 form-inline">
                        <label for="txt_qr">QR長度</label>
                        <input type="text" class="form-control" id="txt_qr" name="txt_qr" maxlength="20" data-error="lan.Error_Event_Name" readonly>
                        <div class="help-block with-errors"></div>
                    </div>
                    <div class="form-group col-md-4 form-inline">
                        <label for="txt_page" style="color:#ff0000!important;">活動網頁</label>
                        <input type="text" class="form-control" id="txt_page" name="txt_page" maxlength="20" data-error="lan.Error_Event_Name">
                        <div class="help-block with-errors"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-md-12 form-inline">
                        <button id="btn_modify" name="btn_modify" type="button" class="btn btn-primary" >
                            <span class="glyphicon glyphicon-saved"></span>&nbsp;&nbsp;&nbsp;&nbsp;儲存&nbsp;&nbsp;&nbsp;&nbsp;
                        </button>
                        &nbsp;&nbsp;
                        <button id="btn_async" name="btn_async" type="button" class="btn btn-warning" onclick="goAsync();">
                            <span class="glyphicon glyphicon-share-alt"></span>&nbsp;&nbsp;&nbsp;&nbsp;同步至會員中心&nbsp;&nbsp;&nbsp;&nbsp;
                        </button>
                        &nbsp;&nbsp;
                        <button id="btn_clear" name="btn_clear" type="button" class="btn btn-danger" onclick="goClear();">
                            <span class="glyphicon glyphicon-trash"></span>&nbsp;&nbsp;&nbsp;&nbsp;重置活動資料&nbsp;&nbsp;&nbsp;&nbsp;
                        </button>
                    </div>
                    <div class="form-group col-md-4 form-inline">
                       
                       
                    </div>

                </div>

            </form>

        </div>
    </div>

</div>

<script>

    var EVENT_NO;
    var CLEAR_ACTION = 100;

    $(document).ready(function () {

        $("#btn_clear").hide();
        $("#btn_async").hide();
        $("#btn_modify").hide();

        $(".dropdown-menu li a").click(function () {
            var eventItem = $(this).text();
            var splits = eventItem.split(' ');
            $("#txt_sh_eventno").val(eventItem);
            //$("#txt_sh_eventname").val(splits[1]);
            getEventInfo(splits[0]);
        });

        $("#btn_modify").click(function () {
            modifyPage();
        });

    })

    function getEventInfo(event_no) {

        var data = "event_no=" + event_no;

        $.ajax({           
            type: "POST",
            url: '@Url.Content("~/")Backend/EventInfo',
            data: data,
            dataType: 'json',
            success: function (data, status, xhr) {

                jDatas = jQuery.parseJSON(data);
                if (jDatas.length == 1) {

                    EVENT_NO = event_no;
                    $("#txt_event_no").val(jDatas[0].AE002);
                    $("#txt_event_name").val(jDatas[0].AE003);
                    $("#txt_vender").val(jDatas[0].AE004);
                    $("#txt_start_date").val(jDatas[0].AE005);
                    $("#txt_end_date").val(jDatas[0].AE006);
                    $("#txt_number").val(jDatas[0].AE007);
                    $("#txt_product").val(jDatas[0].AE008);
                    $("#txt_activity_url").val(jDatas[0].AE009);
                    $("#txt_type").val(jDatas[0].AE010);
                    $("#txt_memo").val(jDatas[0].AE011);
                    $("#txt_qr").val(jDatas[0].AE012);
                    $("#txt_page").val(jDatas[0].AE013);
                    $("#btn_modify").show();
                    $("#btn_async").show();
                    $("#btn_clear").show();
                } else {
                    if (data.ErrorMessage) {
                        //alert(jDatas.ErrorMessage);
                        showQMoal('e', false, data.ErrorMessage, 0, null);
                    }
                    $("#btn_modify").hide();
                    $("#btn_async").hide();
                    $("#btn_clear").hide();

                }
            },
            error: function (request, error) {
                $("#btn_modify").hide();
                $("#btn_async").hide();
                $("#btn_clear").hide();
                alert(error + " : " + request.responseText);
            },
            complete: function () {
                hideLoadingBar();
            }
        });
    }

    function modifyPage() {

        var data = {
            "event_no": EVENT_NO,
            "activity_page": $("#txt_page").val()
        };

        $.ajax({
            type: "POST",
            url: '@Url.Content("~/")Backend/EventModify',
            data: data,
            dataType: 'json',
            success: function (data, status, xhr) {

                jDatas = jQuery.parseJSON(data);
                if (jDatas.result) {
                    showQMoal('i', false, '修改完成', 0, null);

                } else {
                    if (jDatas.ErrorMessage) {
                        showQMoal('e', false, jDatas.ErrorMessage, 0, null);
                    }
                }
            },
            error: function (request, error) {
                alert(error + " : " + request.responseText);
            },
            complete: function () {
                hideLoadingBar();
            }
        });
    }

    function goAsync() {

        var data = "event_no=" + EVENT_NO;

        $.ajax({
            type: "POST",
            url: '@Url.Content("~/")Backend/EventAsync',
            data: data,
            dataType: 'json',
            success: function (data, status, xhr) {

                jDatas = jQuery.parseJSON(data);
                if (jDatas.result) {
                    showQMoal('i', false, '同步完成', 0, null);
                } else {
                    if (jDatas.ErrorMessage) {
                        showQMoal('e', false, jDatas.ErrorMessage, 0, null);
                    }
                }
            },
            error: function (request, error) {
                alert(error + " : " + request.responseText);
            },
            complete: function () {
                hideLoadingBar();
            }
        });
    }

    function onQuestion(action, type) {

        if (type == 'y') {
            if (action == CLEAR_ACTION) {
                doClear();
            }
        } else if (type == 'n') {
        }
    }

    function goClear() {

        showQMoal('q', true, '確定重置活動資料 ?', CLEAR_ACTION, onQuestion);
               
    }

    function doClear() {

        var data = "event_no=" + EVENT_NO;

        $.ajax({
            async: false,
            type: "POST",
            url: '@Url.Content("~/")Backend/EventClear',
            data: data,
            dataType: 'json',
            success: function (data, status, xhr) {

                var source = JSON.parse(data);

                if (source.ErrorMessage) {
                    showQMoal('e', false, source.ErrorMessage, 0, null);
                    peddingHide();
                } else {

                    showQMoal('i', false, '重置活動完成', 0, null);
                    peddingHide();
                }
                /*
                jDatas = jQuery.parseJSON(data);
                if (jDatas.result) {
                    showQMoal('i', false, '重置活動完成', 0, null);
                    peddingHide();
                } else {
                    if (jDatas.ErrorMessage) {
                        showQMoal('e', false, jDatas.ErrorMessage, 0, null);
                    }
                }*
                */
               
            },
            error: function (request, error) {
                alert(error + " : " + request.responseText);
            },
            complete: function () {
                hideLoadingBar();
            }
        });
    }


</script>